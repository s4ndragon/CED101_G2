<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="shortcut icon" href="./images/index/webIcon.png" type="image/x-icon" />
    <link rel="stylesheet" href="css/discuss.css" />
    <title>討論區</title>
</head>


<body>
    @@include('layout/nav.html')
    <main class="pub_back">
        <div class="banner">
            <div>
                <h1>找茶討論</h1>
            </div>
        </div>
        <h2 id="pub_new">發表新文章</h2>

        <form id="pub_article" action="./phps/pubArticle.php" method="post" enctype="multipart/form-data">
            <div class="pub_input_container">
                <label class="input_type upimg_text">文章圖片：</label>
                <label id="preview_con" for="upimg"><img id="preview" src="./images/discuss/uploadimg.png"></label>
                <input id="upimg" type="file" name="img" accept="image/gif,image/jpeg,image/png,image/jpg">
            </div>
            <div class="pub_input_container">
                <label class="input_type">文章類別：</label>
                <select class="slt" name="article_cate">
                    　<option value="揪團心得">揪團心得</option>
                    　<option value="茶園討論">茶園討論</option>
                    　<option value="茶知識">茶知識</option>
                </select>
            </div>
            <label class="input_type" maxlength="15">文章標題：</label>
            <input type="text" name="title">
            <div class="pub_input_container">
                <label class="input_type">文章內文：</label>
                <textarea class="article_input" name="content" maxlength="500" v-model="tex" @input="all"></textarea>
                <div style="text-align: right;">剩餘字數：{{leftword}}</div>
            </div>
            <div class="btn_countainer">
                <button class="btn">
                    <a href="03_discuss.html">取消</a>
                </button>
                <button class="btnsub" type="button" @click="send_data()">
                    送出
                </button>
            </div>
            <!-- ====發表完成確認燈箱==== -->
            <pub></pub>
            <!-- ====隱藏value 用來存篩選分類==== -->
            <input class="category" name="category" type="hidden" value="">
        </form>

    </main>
    @@include('layout/footer.html')
    <!-- vue  -->
    <script src="./js/vue.js"></script>

    <script>
        Vue.component('pub', {
            template: ` <div class="overlay" style="display: none;" >
                            <div class="modal">
                                <form method="post" >
                                    <p class="welcome">發文成功！</p>
                                    <button class="go" type="button" @click="go_discuss">確認</button>
                                </form>
                            </div>
                         </div>`,
            methods: {
                go_discuss() {
                    window.location.href = "./03_discuss.html";
                },
            },
        });


        var app = new Vue({
            el: ".pub_back",
            data: {
                leftword: 500,
                tex: "",
            },
            methods: {
                all: function () {
                    this.leftword = 500 - this.tex.length;
                },

                send_data() {
                    // var form = $('form')[0];
                    var formData = new FormData(form);
                    $.ajax({
                        url: './phps/pubArticle.php', // 要傳送的頁面
                        method: 'POST',               // 使用 POST 方法傳送請求
                        dataType: 'text',             // 回傳資料會是 json 格式
                        contentType: false,
                        cache: false,
                        processData: false,
                        data: formData,  // 將表單資料用打包起來送出去
                        success: function (res) {       // 成功以後會執行這個方法
                            console.log('good');
                            console.log(res);
                            let lightbox = document.querySelectorAll('.overlay')[0];
                            lightbox.style.display = '';
                        },
                        error: function (res) {
                            console.log('not good');
                            console.log(res);
                            let lightbox = document.querySelectorAll('.overlay')[0];
                            lightbox.style.display = '';
                        },
                    });
                },
            },
            mounted() {
                let upload = document.getElementById("upimg");
                upload.addEventListener("change", hand, false);
                function hand() {
                    readURL(this);
                }
                function readURL(input) {
                    if (input.files && input.files[0]) {
                        let reader = new FileReader();
                        reader.onload = function (e) {
                            document.getElementById("preview").src = e.target.result;
                        };
                        reader.readAsDataURL(input.files[0])
                    }
                }
            },
        });


    </script>
</body>

</html>