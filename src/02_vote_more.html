
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>茶園票選</title>
    <link rel="stylesheet" href="./css/vote_more.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.5.3/vue.js"></script>
    <script src="https://unpkg.com/vue-star-rating@1.5.1/dist/star-rating.min.js"></script>
    <script src="../node_modules/vue/dist/vue.js"></script>
    <script src="./js/like.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
</head>

<body>
    @@include('layout/leaf.html')
    @@include('layout/nav.html')
    <div class="banner">
        <p class="fir">茶園排行</p>
    </div>

    <main id="app">
        <div class="all" v-for="garitem in gardenRows">
            <div class="garden">
                <img class="gpic" :src="garitem.GARD_PIC">
            </div>
            <div class="ginfo">
                <div class="s1">
                    <p class="p1">{{garitem.GARD_NAME}}</p>
                    <div class="fb-share-button" data-href="https://tw.yahoo.com/" data-layout="button"
                        data-size="small">
                        <a target="_blank"
                            href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2F127.0.0.1%3A5501%2F07_vote_more.html&amp;src=sdkpreparse"
                            class="fb-xfbml-parse-ignore">
                            分享
                        </a>
                    </div>
                </div>

                <div class="allscore app">
                    <span class="score">
                        總分:&ensp;
                    </span>
                    <div>
                        <star-rating  :rating="garitem.GARD_AVG" :read-only="true" :increment="0.01" :star-size="25"></star-rating>
                    </div>
                </div>

                <p class="p3"><span class="tt">評分次數:</span> {{garitem.GARD_CLICK}}</p>
                <p class="p4">
                    <span class="tt">茶園地址:</span> {{garitem.GARD_ADDRESS}}
                </p>
                <p class="p5">
                    {{garitem.GARD_CONTENT}}
                </p>
                <div class="btwrap app2">
                    
                    <button class="bt myBtn" id="myBtn" @click="show_lightbox(garitem.GARD_ID)">
                        我要評分
                    </button>

                    <!-- overlay -->
                    <div class="overlay" v-if="lightbox"></div>
                    <!-- modal -->
                    <div class="modal" v-if="lightbox">
                        <form>
                            <input type="hidden" id="gardenId">
                            <div class="close"  @click="close_lightbox">
                                
                            </div>
                            <p class="welcome">歡迎評分</p>
                            <div class="app">
                                <div class="star">
                                    <star-rating :increment="0.5" :show-rating="false" @rating-selected="setRating"></star-rating>
                                    <div style="margin-top:10px;font-weight:bold;">{{rating}}</div>                                </div>
                                </div>
                            <div id="btnSendVote" class="go" @click="sendScore">送出</div>
                        </form>
                    </div>
                </div>
            </div>
        </div>


        <div id="commandall">
            <h3 class="t1">茶園留言</h2>
                <!--       留言重複開始         -->
                <div class="command">
                    <div class="nameall">
                        <div class="mem_photo"><img class="mem_photo" src="./images/common/mem_photo1.png" alt=""></div>
                        <span class="pub_mem_name">翰婷</span>
                    </div>
                    <div class="text_excl">
                        <div class="command_text">
                            <div class="pub_text">哈囉，還好吧還好吧還好吧還好吧還好吧，我也要去。</div>
                            <div class="com_pub_time">發表於2012-03-20 12:20:30</div>
                        </div>
                        <div class="excl ">
                            <button class="repobt" @click="showModal2 = true">
                                <img class="excl" src="./images/common/852019_exclamation_512x512.png" alt="">
                            </button>
    
                            <!-- overlay -->
                            <div class="overlay" v-if="showModal2" @click="showModal2 = true"></div>
                            <!-- modal -->
                            <div class="modal" v-if="showModal2">
                                <form>
                                    <div class="close" @click="showModal2 = false">
    
                                    </div>
                                    <p class="welcome">請輸入檢舉理由</p>
                                    <textarea class="repoinfo" cols="25" rows="10"></textarea>
    
                                    <button class="go">送出</button>
                                </form>
                            </div>
    
                        </div>
                    </div>
                </div>
                <div class="command">
                    <div class="nameall">
                        <div class="mem_photo"><img class="mem_photo" src="./images/common/mem_photo1.png" alt=""></div>
                        <span class="pub_mem_name">翰婷</span>
                    </div>
                    <div class="text_excl ">
                        <div class="command_text">
                            <div class="pub_text">哈囉，還好吧還好吧還好吧還好吧還好吧，我也要去。</div>
                            <div class="com_pub_time">發表於2012-03-20 12:20:30</div>
                        </div>
                        <div class="excl ">
                            <button class="repobt" @click="showModal2 = true">
                                <img class="excl" src="./images/common/852019_exclamation_512x512.png" alt="">
                            </button>
    
                            <!-- overlay -->
                            <div class="overlay" v-if="showModal2" @click="showModal2 = true"></div>
                            <!-- modal -->
                            <div class="modal" v-if="showModal2">
                                <form>
                                    <div class="close" @click="showModal2 = false">
                                        
                                    </div>
                                    <p class="welcome">請輸入檢舉理由</p>
                                    <textarea class="repoinfo" cols="25" rows="10"></textarea>
    
                                    <button class="go">送出</button>
                                </form>
                            </div>
    
                        </div>
                    </div>
                </div>
                <div class="command">
                    <div class="nameall">
                        <div class="mem_photo"><img class="mem_photo" src="./images/common/mem_photo1.png" alt=""></div>
                        <span class="pub_mem_name">翰婷</span>
                    </div>
                    <div class="text_excl">
                        <div class="command_text">
                            <div class="pub_text">哈囉，還好吧還好吧還好吧還好吧還好吧，我也要去。</div>
                            <div class="com_pub_time">發表於2012-03-20 12:20:30</div>
                        </div>
                        <div class="excl ">
                            <button class="repobt" @click="showModal2 = true">
                                <img class="excl" src="./images/common/852019_exclamation_512x512.png" alt="">
                            </button>
    
                            <!-- overlay -->
                            <div class="overlay" v-if="showModal2" @click="showModal2 = true"></div>
                            <!-- modal -->
                            <div class="modal" v-if="showModal2">
                                <form>
                                    <div class="close" @click="showModal2 = false">
                                        
                                    </div>
                                    <p class="welcome">請輸入檢舉理由</p>
                                    <textarea class="repoinfo" cols="25" rows="10"></textarea>
    
                                    <button class="go">送出</button>
                                </form>
                            </div>
    
                        </div>
                    </div>
                </div>

        </div>

        <form action="">
            <div class="input_container">
                <h3>新增留言</h3>
                <div class="create_command_container">
                    <textarea class="create_command"></textarea>
                    <div class="com_btn_countainer">
                        <button class="inner_btn">
                            <a href="03_discuss.html">送出</a>
                        </button>
                    </div>
                </div>
            </div>

        </form>

        <h3>相關熱門揪團</h3>
        <div class="tour_browse_block" id="tourBrowseBlock"></div>

        <div class="toursection">
            <div v-for="tourRow in tourRows" class="tour_block">
                <div class="tour_img">
                    <p>{{tourRow.TOUR_TITLE}}</p>
                    <p>{{tourRow.TOUR_SETOFFTIME}} 出團</p>
                    <img :src="tourRow.TOUR_IMG">
                </div>

                <div class="love_share">
                    <div class="love">
                        <img class="like" src="./images/common/heart.png" title="加入收藏" alt="">
                    </div>
                    <div class="share">
                        <div class="fb-share-button" data-href="http://127.0.0.1:5501/dist/01_tour.html" data-layout="button" data-size="small"><a target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2F127.0.0.1%3A5501%2Fdist%2F01_tour.html&amp;src=sdkpreparse" class="fb-xfbml-parse-ignore">分享</a></div>
                    </div>
                </div>

                <div class="tour_text">
                    <div class="deadline">
                        <h3>截止揪團日期</h3>
                        <p>{{tourRow.DEADLINE_DATE}}</p>
                    </div>
                    <div class="price">
                        <h3>預估費用</h3>
                        <p>${{tourRow.GARD_PRICE}}</p>
                    </div>
                    <div class="ink">
                        <div class="ink_bg"></div>
                        <div class="inkText">
                            <h3>參加人數</h3>
                            <p>{{tourRow.NUM_OF_PARTICIPANTS}}/{{tourRow.TOUR_PEOPLE}}</p>
                        </div>
                    </div>
                </div>

                <div class="tourBtn">
                    <button type="button">
                        <a :href="'02_tour_more.html?TOUR_ID=' + tourRow.TOUR_ID"> 立即報名</a>
                    </button>
                </div>
            </div>

            

        </div>

        <div class="btwrap">
            <button class="bt">
                <a href="01_tour.html">
                    瀏覽更多揪團
                </a>
            </button>
        </div>
    </main>

    @@include('layout/footer.html')


    <script>
        
        Vue.component("star-rating", VueStarRating.default);

        var app = new Vue({
            el: "#app",
            data: {
                dataRows:'',
                gardenRows:'',
                tourRows:'',
                pastDate:'',
                lightbox: false,
                lightbox_GARD_ID:'',

                showModal2: false,
                rating: '您尚未評分',
                sendRating:'',
                targetPageId:'',
                today:''
            },

            methods: {
                show_lightbox(GARD_ID){
                    this.lightbox = true;
                    this.lightbox_GARD_ID = GARD_ID;
                },

                close_lightbox(){
                    this.lightbox = false;
                    this.rating = '您尚未評分';
                },

                setRating(rating) {
                    this.rating = "您評了 " + rating + " 分";
                    return this.sendRating = rating;
                },

                nowDate(){
                    let today = new Date();
                    let dd = today.getDate();
                    let mm = today.getMonth()+1; 
                    let yyyy = today.getFullYear();
                    if(dd<10){
                        dd='0'+dd;
                    } 
                    if(mm<10) {
                        mm='0'+mm;
                    }
                    today = yyyy+'-'+mm+'-'+dd;
                    this.today = today
                },

                sendScore(){
                    if(this.today == this.pastDate[0].VOTE_DATE){
                        alert('一天只能投一次票喔!')
                    }else{
                        let xhr = new XMLHttpRequest();
                        xhr.onload = function(){
                            if(xhr.status == 200){ //success
                                console.log('success')
                            }else{
                                alert(xhr.status);
                            }
                        }
                        xhr.open("post", "./phps/send_vote.php", true);
                        xhr.setRequestHeader("content-type", "application/x-www-form-urlencoded");
                        //送出資料
                        let data_info = "GARD_VOTE=" + this.sendRating + "&" + "GARD_ID=" + this.targetPageId;
                        xhr.send(data_info);

                        this.lightbox = false
                        this.get_data()
                        this.rating = '您尚未評分'
                    }
                },

                get_data(){
                    //============傳targetPageId給php
                    
                    let xhr = new XMLHttpRequest();
                        //註冊callback function 
                        xhr.onload = function(){
                            if(xhr.status == 200){ //success
                                app.dataRows = JSON.parse(xhr.responseText);
                                app.gardenRows = app.dataRows[0];
                                app.pastDate = app.dataRows[1];
                                app.tourRows = app.dataRows[2];
                            }else{
                                alert(xhr.status);
                            }
                        }
                        //設定好所要連結的程式
                        xhr.open("post", "./phps/vote_more.php", true);
                        xhr.setRequestHeader("content-type", "application/x-www-form-urlencoded");
                        //送出資料
                        // let data_info = "GARD_ID=" + this.targetPageId;
                        let data_info = `GARD_ID=${this.targetPageId}`;
                        xhr.send(data_info);
                }
            },

            mounted() {
                let searchURL = window.location.search;
                searchURL = searchURL.substring(1, searchURL.length);
                let targetPageId = searchURL.split("=")[1];
                this.targetPageId = targetPageId;

                //============去server端拿資料
                this.get_data()
                this.nowDate()
                

            },
        });

    </script>

    

    <div id="fb-root"></div>
    <script async defer crossorigin="anonymous" src="https://connect.facebook.net/zh_TW/sdk.js#xfbml=1&version=v9.0"
        nonce="WuFFSzIJ"></script>
</body>

</html>